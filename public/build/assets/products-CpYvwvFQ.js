document.querySelectorAll(".form-dinamico").forEach(e=>{e.addEventListener("submit",function(t){if(t.preventDefault(),!this.action){console.error("Formulario sin action definida",this);return}e.querySelectorAll(".error-message").forEach(n=>n.textContent=""),e.querySelectorAll("input, select, textarea").forEach(n=>n.classList.remove("border-red-500"));const o=new FormData(this);fetch(this.action,{method:this.method||"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,Accept:"application/json"},body:o}).then(async n=>{if(n.status===422){const{errors:a}=await n.json();throw Object.keys(a).forEach(s=>{const c=s.replace(/\.(\d+)/g,"[$1]").replace(/\.(\w+)/g,"[$1]"),r=e.querySelector(`[name="${c}"]`);if(r){r.classList.add("border-red-500");const i=r.closest("div")?.querySelector(".error-message");i&&(i.textContent=a[s][0])}}),new Error("Validation error")}return n.json()}).then(n=>{n.success&&(new Notyf({duration:1e3,position:{x:"right",y:"top"}}).success(n.message),setTimeout(()=>{window.location.href=n.redirect},1e3))}).catch(n=>console.error("❌ Error:",n))})});function l(e,t,o=[],n=!1,a="ingredientes[]"){t&&(t.innerHTML="",e&&fetch(`/ingredientes/tipo/${e}`).then(s=>s.json()).then(s=>{if(!s.length){t.innerHTML="<p class='text-gray-500'>No hay ingredientes</p>";return}const c={};s.forEach(r=>{const i=r.categoria?.nombre||"Otros",d=r.categoria?.orden??999;c[i]||(c[i]={orden:d,items:[]}),c[i].items.push(r)}),Object.entries(c).sort((r,i)=>r[1].orden-i[1].orden).forEach(([r,i])=>{const d=document.createElement("div");d.className="border rounded p-3 mb-3",d.innerHTML=`<h4 class="font-semibold mb-2">${r}</h4>`,i.items.forEach(f=>{const g=n||o.includes(f.id);d.insertAdjacentHTML("beforeend",`
                            <div class="flex items-center gap-2 mb-1">
                                <input
                                    type="checkbox"
                                    name="${a}"
                                    value="${f.id}"
                                    ${g?"checked":""}
                                >
                                <span class="text-sm">${f.nombre}</span>
                            </div>
                        `)}),t.appendChild(d)})}).catch(s=>{console.error("Error cargando ingredientes:",s),t.innerHTML="<p class='text-red-500'>Error al cargar ingredientes</p>"}))}document.getElementById("tipo_producto_id")?.addEventListener("change",function(){const e=this.value,t=document.getElementById("ingredientes-base-container"),o=document.getElementById("ingredientes-extra-container");l(e,t,[],!1,"ingredientes[]"),l(e,o,[],!0,"ingredientes_extra[]")});document.getElementById("tipo_producto_id_edit")?.addEventListener("change",function(){const e=document.getElementById("form-articulos-edit");if(!e)return;const t=e.querySelector("#ingredientes-base-container"),o=e.querySelector("#ingredientes-extra-container");l(this.value,t,[],!1,"ingredientes[]"),l(this.value,o,[],!0,"ingredientes_extra[]")});document.querySelectorAll("[data-open]").forEach(e=>{e.addEventListener("click",()=>{const t=document.getElementById(e.dataset.open);if(!t)return;if(!(void 0).getAttribute("action")){console.error("Formulario sin action:",void 0);return}t.classList.remove("hidden"),e.dataset.url&&(t.action=e.dataset.url),Object.entries(e.dataset).forEach(([s,c])=>{if(["open","url","ingredientes","ingredientes_extra"].includes(s))return;const r=t.querySelector(`[name="${s}"]`);r&&(r.type==="checkbox"?r.checked=c==="1":r.value=c??"")});const o=e.dataset.tipo_producto_id;if(!o)return;const n=e.dataset.ingredientes?JSON.parse(e.dataset.ingredientes):[],a=e.dataset.ingredientes_extra?JSON.parse(e.dataset.ingredientes_extra):[];l(o,t.querySelector("#ingredientes-container"),n,!1,"ingredientes[]"),l(o,t.querySelector("#ingredientes-extra-container"),a,!1,"ingredientes_extra[]")})});document.querySelectorAll("[data-close]").forEach(e=>{e.addEventListener("click",()=>{const t=document.getElementById(e.dataset.close);t&&(t.classList.add("hidden"),t.reset(),t.querySelectorAll(".error-message").forEach(o=>o.textContent=""),t.querySelectorAll("input, select, textarea").forEach(o=>o.classList.remove("border-red-500")))})});let u=null,m=null;document.addEventListener("click",e=>{const t=e.target.closest(".delete-btn");t&&(u=t.dataset.url,m=t.closest("tr"),document.getElementById("modal-delete-message").textContent=`Esta acción eliminará ${t.dataset.name||"este registro"}.`,document.getElementById("modal-confirm-delete").classList.remove("hidden"))});document.getElementById("cancel-delete")?.addEventListener("click",()=>{document.getElementById("modal-confirm-delete").classList.add("hidden"),u=m=null});document.getElementById("confirm-delete")?.addEventListener("click",()=>{u&&fetch(u,{method:"DELETE",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,Accept:"application/json"}}).then(e=>e.json()).then(e=>{e.success&&m&&m.remove()}).finally(()=>{document.getElementById("modal-confirm-delete").classList.add("hidden"),u=m=null})});
